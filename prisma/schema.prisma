// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Enum for user roles
enum UserRole {
  USER // Testeur
  PRO // Vendeur
  ADMIN // Administrateur
}

// Enum for campaign status
enum CampaignStatus {
  DRAFT // Brouillon
  PENDING_PAYMENT // En attente de paiement par le vendeur
  ACTIVE // Active et visible par les testeurs (pay√©e)
  COMPLETED // Termin√©e (d√©lai d√©pass√© ou stock √©puis√©)
  CANCELLED // Annul√©e par le vendeur
}

// Enum for log levels
enum LogLevel {
  INFO // üîµ Informations g√©n√©rales
  SUCCESS // ‚úÖ Succ√®s d'op√©ration
  WARNING // ‚ö†Ô∏è Avertissements
  ERROR // ‚ùå Erreurs
  DEBUG // üêõ Debug technique
}

// Enum for log categories
enum LogCategory {
  AUTH // Authentification
  USER // Gestion utilisateurs
  PRODUCT // Gestion produits
  CAMPAIGN // Gestion campagnes
  PROCEDURE // Proc√©dures de test
  SESSION // Sessions de test
  WALLET // Transactions financi√®res
  MESSAGE // Messagerie
  ADMIN // Actions admin
  SYSTEM // Syst√®me g√©n√©ral
  TEST // Endpoints de test
  TEST_API // Tests automatis√©s de l'API
}

// Enum for test step types
enum StepType {
  TEXT // Instructions texte simple
  PHOTO // Demander une photo
  VIDEO // Demander une vid√©o
  CHECKLIST // Liste de v√©rification
  RATING // Notation (1-5 √©toiles)
  PRICE_VALIDATION // Validation du prix (step automatique final)
}

// Enum for notification types
enum NotificationType {
  SESSION_APPLIED // Nouvelle candidature
  SESSION_ACCEPTED // Candidature accept√©e
  SESSION_REJECTED // Candidature refus√©e
  PURCHASE_SUBMITTED // Preuve d'achat soumise
  TEST_SUBMITTED // Test soumis
  TEST_VALIDATED // Test valid√©
  SESSION_CANCELLED // Session annul√©e
  DISPUTE_CREATED // Litige cr√©√©
  MESSAGE_RECEIVED // Nouveau message
  PAYMENT_RECEIVED // Paiement re√ßu
  CAMPAIGN_CREATED // Nouvelle campagne
  CAMPAIGN_ENDING_SOON // Campagne se termine bient√¥t
  SYSTEM_ALERT // Alerte syst√®me
}

// Enum for notification channels
enum NotificationChannel {
  EMAIL // Email
  SMS // SMS
  PUSH // Push notification
  IN_APP // Notification in-app
}

// Enum for testing session status
enum SessionStatus {
  PENDING // En attente d'acceptation par le vendeur
  ACCEPTED // Accept√©e par le vendeur
  IN_PROGRESS // Test en cours (produit achet√©)
  SUBMITTED // Test soumis, en attente de validation
  COMPLETED // Test valid√© et pay√©
  REJECTED // Refus√©e par le vendeur
  CANCELLED // Annul√©e par le testeur
  DISPUTED // En litige (besoin intervention admin)
}

// Enum for distribution types
enum DistributionType {
  RECURRING // Jours r√©currents (tous les lundis, mercredis, etc.)
  SPECIFIC_DATE // Date sp√©cifique (3 novembre, 15 novembre, etc.)
}

// Enum for bonus task types
enum BonusTaskType {
  UNBOXING_PHOTO // Photos de d√©ballage
  UGC_VIDEO // Vid√©o UGC
  EXTERNAL_REVIEW // Avis sur site externe
  TIP // Conseil/astuce
  CUSTOM // Autre (√† pr√©ciser)
}

// Enum for bonus task status
enum BonusTaskStatus {
  REQUESTED // Vendeur a cr√©√© la demande
  ACCEPTED // Testeur a accept√©
  REJECTED // Testeur a refus√©
  SUBMITTED // Testeur a soumis le travail
  VALIDATED // Vendeur a valid√© ‚Üí paiement
  CANCELLED // Annul√© par le vendeur
}

// Enum for chat order types
enum ChatOrderType {
  UGC_REQUEST // Demande de contenu UGC (vid√©os, reviews)
  PHOTO_REQUEST // Demande de photos suppl√©mentaires
  TIP // Pourboire/bonus
}

// Enum for chat order status
enum ChatOrderStatus {
  PENDING // En attente d'acceptation par le testeur
  ACCEPTED // Accept√©e par le testeur, en cours
  DELIVERED // Livr√©e par le testeur, en attente de validation PRO
  COMPLETED // Valid√©e par le PRO, paiement lib√©r√©
  REJECTED // Refus√©e par le testeur
  CANCELLED // Annul√©e par le PRO (avant acceptation)
  DISPUTED // En litige, fonds bloqu√©s
  REFUNDED // Rembours√©e au PRO (litige r√©solu en faveur PRO)
}

// Profile table - extends Supabase auth.users
model Profile {
  id             String   @id @default(uuid())
  supabaseUserId String   @unique @map("supabase_user_id")
  email          String   @unique
  role           UserRole @default(USER)

  firstName String? @map("first_name")
  lastName  String? @map("last_name")
  phone     String?
  avatar    String?

  // Push notification device token
  deviceToken String? @map("device_token") // FCM device token for push notifications

  // Stripe integration fields
  stripeCustomerId String? @unique @map("stripe_customer_id") // Stripe Customer ID (for payment methods)
  stripeAccountId  String? @unique @map("stripe_account_id") // Stripe Connected Account ID (for sellers - payout)

  // KYC Stripe Identity (pour verification d'identit√© des testeurs)
  stripeVerificationSessionId String?   @unique @map("stripe_verification_session_id") // Stripe Identity VerificationSession ID
  verificationStatus          String?   @default("unverified") @map("verification_status") // unverified, pending, verified, failed
  verifiedAt                  DateTime? @map("verified_at") // Date de v√©rification r√©ussie
  verificationFailedReason    String?   @map("verification_failed_reason") @db.Text // Raison de l'√©chec si failed

  // Tester specific info (for USER role)
  birthDate              DateTime? @map("birth_date") // Date de naissance pour calculer l'√¢ge
  gender                 String? // M, F, Other
  location               String? // Ville/r√©gion
  country                String? // Code pays (ex: FR, US)
  averageRating          Decimal?  @default(0) @map("average_rating") @db.Decimal(3, 2) // Note moyenne (0-5)
  completedSessionsCount Int       @default(0) @map("completed_sessions_count") // Nombre de tests compl√©t√©s
  preferredCategories    String[]  @map("preferred_categories") // IDs des cat√©gories pr√©f√©r√©es

  // Performance statistics (for eligibility criteria)
  cancelledSessionsCount Int       @default(0) @map("cancelled_sessions_count") // Nombre de sessions annul√©es
  totalSessionsCount     Int       @default(0) @map("total_sessions_count") // Nombre total de sessions
  lastActiveAt           DateTime? @map("last_active_at") // Derni√®re activit√©

  // Premium status (future feature)
  isPrime Boolean @default(false) @map("is_prime") // Statut premium

  // Business info for PRO users
  companyName String? @map("company_name")
  siret       String?

  // Account status
  isActive   Boolean @default(true) @map("is_active")
  isVerified Boolean @default(false) @map("is_verified")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  products                Product[] // Produits cr√©√©s par ce vendeur
  campaigns               Campaign[] // Campagnes cr√©√©es par ce vendeur
  systemLogs              SystemLog[] // Logs d'actions de cet utilisateur
  sessions                Session[] // Sessions (en tant que testeur)
  messages                Message[] // Messages envoy√©s
  chatOrdersAsBuyer       ChatOrder[]             @relation("ChatOrderBuyer") // Commandes en tant qu'acheteur (PRO)
  chatOrdersAsSeller      ChatOrder[]             @relation("ChatOrderSeller") // Commandes en tant que vendeur (Testeur)
  notifications           Notification[] // Notifications re√ßues
  notificationPreferences NotificationPreference? // Pr√©f√©rences de notification
  reviews                 CampaignReview[]        @relation("TesterReviews") // Avis cr√©√©s (en tant que testeur)
  requestedBonusTasks BonusTask[]             @relation("RequestedBonusTasks") // Prestations suppl√©mentaires cr√©√©es (en tant que vendeur)
  wallet              Wallet? // Portefeuille financier (pour les testeurs)
  withdrawals         Withdrawal[] // Demandes de retrait (pour les testeurs)
  procedureTemplates  ProcedureTemplate[]     @relation("SellerProcedureTemplates") // Templates de proc√©dures (pour les vendeurs)
  criteriaTemplates   CriteriaTemplate[]      @relation("SellerCriteriaTemplates") // Templates de crit√®res (pour les vendeurs)

  @@index([email])
  @@index([supabaseUserId])
  @@index([role])
  @@index([verificationStatus])
  @@map("profiles")
}

// Product table - Catalogue de produits du vendeur
// Category table - Product categories
model Category {
  id String @id @default(uuid())

  // Category information
  name        String  @unique
  slug        String  @unique // URL-friendly version (e.g., "electronique")
  description String? @db.Text
  icon        String? // Optional icon/emoji for UI

  // Availability
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  products Product[] // Produits dans cette cat√©gorie

  @@index([slug])
  @@index([isActive])
  @@map("categories")
}

model Product {
  id String @id @default(uuid())

  // Relation with seller (PRO)
  sellerId String  @map("seller_id")
  seller   Profile @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  // Relation with category
  categoryId String?   @map("category_id")
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Product information (catalogue de base)
  name        String
  description String  @db.Text
  imageUrl    String? @map("image_url") // Legacy field - kept for backward compatibility
  productUrl  String? @map("product_url")
  images      Json?   // Array of image objects: [{ url: string, order: number, isPrimary: boolean }]

  // Pricing information
  price        Decimal @default(0) @db.Decimal(10, 2)
  shippingCost Decimal @default(0) @map("shipping_cost") @db.Decimal(10, 2)

  // Availability
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  offers  Offer[] // Offres de ce produit dans diff√©rentes campagnes
  reviews CampaignReview[] // Avis sur ce produit (via campagnes)

  @@index([sellerId])
  @@index([categoryId])
  @@index([isActive])
  @@map("products")
}

// Campaign table - Test campaigns created by PRO sellers
model Campaign {
  id String @id @default(uuid())

  // Relation with seller (PRO)
  sellerId String  @map("seller_id")
  seller   Profile @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  // Campaign information
  title       String
  description String @db.Text

  // Campaign timing
  startDate DateTime  @map("start_date")
  endDate   DateTime? @map("end_date") // Optional, campaign can end by stock instead

  // Slot management (nombre de tests disponibles)
  totalSlots     Int @map("total_slots") // Total number of test slots
  availableSlots Int @map("available_slots") // Remaining available slots

  // Status
  status CampaignStatus @default(DRAFT)

  // Application acceptance mode
  autoAcceptApplications Boolean @default(false) @map("auto_accept_applications") // Si true, candidatures √©ligibles accept√©es automatiquement

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  offers        Offer[] // Offres de cette campagne
  procedures    Procedure[] // Proc√©dures de cette campagne
  distributions Distribution[] // Calendrier de distribution
  sessions      Session[] // Sessions pour cette campagne
  reviews       CampaignReview[] // Avis sur cette campagne
  criteria      CampaignCriteria? // Crit√®res de s√©lection des testeurs
  transactions  Transaction[] // Transactions li√©es √† cette campagne (paiements vendeur)

  @@index([sellerId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([autoAcceptApplications])
  @@map("campaigns")
}

// Offer table - Offre d'un produit dans une campagne avec toutes les donn√©es financi√®res
model Offer {
  id String @id @default(uuid())

  // Relations
  campaignId String   @map("campaign_id")
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Prix du produit et livraison (d√©finis par le vendeur)
  expectedPrice   Decimal @map("expected_price") @db.Decimal(10, 2) // Prix exact attendu du produit
  shippingCost    Decimal @default(0) @map("shipping_cost") @db.Decimal(10, 2) // Frais de livraison attendus
  priceRangeMin   Decimal @map("price_range_min") @db.Decimal(10, 2) // Tranche de prix min pour validation testeur
  priceRangeMax   Decimal @map("price_range_max") @db.Decimal(10, 2) // Tranche de prix max pour validation testeur
  isPriceRevealed Boolean @default(false) @map("is_price_revealed") // Le prix exact est-il r√©v√©l√© aux testeurs ?

  // Remboursements (oui/non)
  reimbursedPrice    Boolean @default(true) @map("reimbursed_price") // Le prix du produit est-il rembours√© ?
  reimbursedShipping Boolean @default(true) @map("reimbursed_shipping") // Les frais de livraison sont-ils rembours√©s ?

  // Montants maximum de remboursement (optionnels)
  maxReimbursedPrice    Decimal? @map("max_reimbursed_price") @db.Decimal(10, 2) // Prix maximum rembours√© (si null = remboursement total)
  maxReimbursedShipping Decimal? @map("max_reimbursed_shipping") @db.Decimal(10, 2) // Livraison maximum rembours√©e (si null = remboursement total)

  // Bonus suppl√©mentaire pour le testeur
  bonus Decimal @default(0) @db.Decimal(10, 2) // Bonus en plus des remboursements

  // Quantit√© de ce produit dans la campagne
  quantity Int @default(1)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([campaignId, productId]) // Un produit ne peut √™tre dans la campagne qu'une seule fois
  @@index([campaignId])
  @@index([productId])
  @@map("offers")
}

// CampaignCriteria table - Crit√®res de s√©lection des testeurs pour une campagne
model CampaignCriteria {
  id String @id @default(uuid())

  // Relation with campaign (one-to-one)
  campaignId String   @unique @map("campaign_id")
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  // Age criteria
  minAge Int? @map("min_age") // √Çge minimum
  maxAge Int? @map("max_age") // √Çge maximum

  // Rating criteria
  minRating Decimal? @map("min_rating") @db.Decimal(3, 2) // Note minimum (0-5)
  maxRating Decimal? @map("max_rating") @db.Decimal(3, 2) // Note maximum (0-5)

  // Experience criteria
  minCompletedSessions Int? @map("min_completed_sessions") // Nombre minimum de tests compl√©t√©s

  // Gender criteria
  requiredGender String? @map("required_gender") // M, F, ALL, null

  // Location criteria
  requiredCountries String[] @map("required_countries") // Liste de pays accept√©s
  requiredLocations String[] @map("required_locations") // Liste de villes/r√©gions accept√©es
  excludedLocations String[] @map("excluded_locations") // Liste de villes/r√©gions exclues

  // Category preferences
  requiredCategories String[] @map("required_categories") // IDs des cat√©gories requises dans les pr√©f√©rences

  // Anti-duplicate seller criteria
  noActiveSessionWithSeller Boolean @default(false) @map("no_active_session_with_seller") // Pas de session en cours avec ce vendeur

  // Participation limits
  maxSessionsPerWeek  Int? @map("max_sessions_per_week") // Maximum de sessions par semaine
  maxSessionsPerMonth Int? @map("max_sessions_per_month") // Maximum de sessions par mois

  // Quality criteria
  minCompletionRate   Decimal? @map("min_completion_rate") @db.Decimal(5, 2) // Taux de compl√©tion minimum (%)
  maxCancellationRate Decimal? @map("max_cancellation_rate") @db.Decimal(5, 2) // Taux d'annulation maximum (%)

  // Temporal criteria
  minAccountAge        Int? @map("min_account_age") // Anciennet√© minimum du compte (jours)
  lastActiveWithinDays Int? @map("last_active_within_days") // Actif dans les X derniers jours

  // Verification criteria
  requireVerified Boolean @default(false) @map("require_verified") // Compte v√©rifi√© obligatoire

  // Premium criteria (future feature)
  requirePrime Boolean @default(false) @map("require_prime") // Statut premium obligatoire

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([campaignId])
  @@map("campaign_criteria")
}

// SystemLog table - Logs syst√®me pour tra√ßabilit√© et debug
model SystemLog {
  id       String      @id @default(uuid())
  level    LogLevel
  category LogCategory

  // Message
  message String // Message simple pour affichage
  details Json? // Donn√©es compl√®tes (visible admin uniquement)

  // User context
  userId String?  @map("user_id")
  user   Profile? @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Request context
  ipAddress  String? @map("ip_address")
  userAgent  String? @map("user_agent")
  endpoint   String? // Route API appel√©e
  method     String? // GET, POST, etc.
  statusCode Int?    @map("status_code")
  duration   Int? // Temps d'ex√©cution en ms

  createdAt DateTime @default(now()) @map("created_at")

  @@index([level])
  @@index([category])
  @@index([userId])
  @@index([createdAt])
  @@map("system_logs")
}

// Procedure table - Proc√©dures d√©finies par le vendeur
model Procedure {
  id String @id @default(uuid())

  // Relation with campaign
  campaignId String   @map("campaign_id")
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  // Procedure info
  title       String
  description String  @db.Text
  order       Int // Ordre d'ex√©cution
  isRequired  Boolean @default(true) @map("is_required")

  // Relations
  steps Step[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([campaignId])
  @@index([order])
  @@map("procedures")
}

// Step table - √âtapes d√©taill√©es d'une proc√©dure
model Step {
  id String @id @default(uuid())

  // Relation with procedure
  procedureId String    @map("procedure_id")
  procedure   Procedure @relation(fields: [procedureId], references: [id], onDelete: Cascade)

  // Step info
  title       String
  description String?  @db.Text
  type        StepType @default(TEXT)
  order       Int
  isRequired  Boolean  @default(true) @map("is_required")

  // For CHECKLIST type
  checklistItems Json? @map("checklist_items")

  // Relations
  progressTracking SessionStepProgress[] // Progression de ce step dans les sessions

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([procedureId])
  @@index([order])
  @@map("steps")
}

// ProcedureTemplate table - Templates de proc√©dures r√©utilisables
model ProcedureTemplate {
  id String @id @default(uuid())

  // Relation with seller (owner of the template)
  sellerId String  @map("seller_id")
  seller   Profile @relation("SellerProcedureTemplates", fields: [sellerId], references: [id], onDelete: Cascade)

  // Template info
  name        String // Nom du template pour le vendeur
  title       String // Titre qui sera copi√© dans la proc√©dure
  description String @db.Text

  // Relations
  steps StepTemplate[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([sellerId])
  @@map("procedure_templates")
}

// StepTemplate table - √âtapes d'un template de proc√©dure
model StepTemplate {
  id String @id @default(uuid())

  // Relation with procedure template
  procedureTemplateId String            @map("procedure_template_id")
  procedureTemplate   ProcedureTemplate @relation(fields: [procedureTemplateId], references: [id], onDelete: Cascade)

  // Step info
  title       String
  description String?  @db.Text
  type        StepType @default(TEXT)
  order       Int
  isRequired  Boolean  @default(true) @map("is_required")

  // For CHECKLIST type
  checklistItems Json? @map("checklist_items")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([procedureTemplateId])
  @@index([order])
  @@map("step_templates")
}

// CriteriaTemplate table - Templates de crit√®res d'√©ligibilit√© r√©utilisables
model CriteriaTemplate {
  id String @id @default(uuid())

  // Relation with seller (owner of the template)
  sellerId String  @map("seller_id")
  seller   Profile @relation("SellerCriteriaTemplates", fields: [sellerId], references: [id], onDelete: Cascade)

  // Template info
  name String // Nom du template pour le vendeur

  // Age criteria
  minAge Int? @map("min_age")
  maxAge Int? @map("max_age")

  // Rating criteria
  minRating Decimal? @map("min_rating") @db.Decimal(3, 2)
  maxRating Decimal? @map("max_rating") @db.Decimal(3, 2)

  // Experience criteria
  minCompletedSessions Int? @map("min_completed_sessions")

  // Gender criteria
  requiredGender String? @map("required_gender")

  // Location criteria
  requiredCountries String[] @map("required_countries")
  requiredLocations String[] @map("required_locations")
  excludedLocations String[] @map("excluded_locations")

  // Category preferences
  requiredCategories String[] @map("required_categories")

  // Anti-duplicate seller criteria
  noActiveSessionWithSeller Boolean @default(false) @map("no_active_session_with_seller")

  // Participation limits
  maxSessionsPerWeek  Int? @map("max_sessions_per_week")
  maxSessionsPerMonth Int? @map("max_sessions_per_month")

  // Quality criteria
  minCompletionRate   Decimal? @map("min_completion_rate") @db.Decimal(5, 2)
  maxCancellationRate Decimal? @map("max_cancellation_rate") @db.Decimal(5, 2)

  // Temporal criteria
  minAccountAge        Int? @map("min_account_age")
  lastActiveWithinDays Int? @map("last_active_within_days")

  // Verification criteria
  requireVerified Boolean @default(false) @map("require_verified")
  requirePrime    Boolean @default(false) @map("require_prime")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([sellerId])
  @@map("criteria_templates")
}

// SessionStepProgress table - Tracking de la progression des testeurs dans les steps
model SessionStepProgress {
  id String @id @default(uuid())

  // Relations
  sessionId String  @map("session_id")
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  stepId String @map("step_id")
  step   Step   @relation(fields: [stepId], references: [id], onDelete: Cascade)

  // Progress info
  isCompleted Boolean   @default(false) @map("is_completed")
  completedAt DateTime? @map("completed_at")

  // Submission data (photos, videos, text, checklist answers, rating)
  submissionData Json? @map("submission_data")

  // For PRICE_VALIDATION step - prix saisi par le testeur
  validatedPrice Decimal? @map("validated_price") @db.Decimal(10, 2)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([sessionId, stepId]) // Un step ne peut √™tre compl√©t√© qu'une fois par session
  @@index([sessionId])
  @@index([stepId])
  @@index([isCompleted])
  @@map("session_step_progress")
}

// Distribution table - Calendrier de distribution de la campagne
// D√©finit QUAND les testeurs peuvent candidater (pas le nombre de slots, qui est dans Campaign)
model Distribution {
  id String @id @default(uuid())

  // Relation with campaign
  campaignId String   @map("campaign_id")
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  // Type de distribution
  type DistributionType

  // Pour RECURRING : jours de la semaine r√©currents (0 = Dimanche, 1 = Lundi, ..., 6 = Samedi)
  dayOfWeek Int? @map("day_of_week") // 0-6 (nullable, utilis√© uniquement si type = RECURRING)

  // Pour SPECIFIC_DATE : date sp√©cifique dans l'ann√©e
  specificDate DateTime? @map("specific_date") // Date pr√©cise (nullable, utilis√© uniquement si type = SPECIFIC_DATE)

  // Nombre maximum d'unit√©s √† distribuer pour ce jour
  maxUnits Int @default(10) @map("max_units")

  // Statut actif
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([campaignId])
  @@index([type])
  @@index([dayOfWeek])
  @@index([specificDate])
  @@index([isActive])
  @@map("distributions")
}

// Session table - Session active entre un testeur et une campagne
model Session {
  id String @id @default(uuid())

  // Relations
  campaignId String   @map("campaign_id")
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  testerId String  @map("tester_id")
  tester   Profile @relation(fields: [testerId], references: [id], onDelete: Cascade)

  // Session status
  status SessionStatus @default(PENDING)

  // Application (candidature du testeur)
  applicationMessage String?  @map("application_message") @db.Text // Message de motivation
  appliedAt          DateTime @default(now()) @map("applied_at")

  // Acceptance/Rejection by seller
  acceptedAt      DateTime? @map("accepted_at")
  rejectedAt      DateTime? @map("rejected_at")
  rejectionReason String?   @map("rejection_reason") @db.Text

  // Scheduled purchase (based on Distribution - date obligatoire d'achat)
  scheduledPurchaseDate DateTime? @map("scheduled_purchase_date") // Date √† laquelle le testeur DOIT acheter le produit

  // Purchase proof
  purchaseProofUrl       String?   @map("purchase_proof_url") // URL de la preuve d'achat
  purchasedAt            DateTime? @map("purchased_at")
  orderNumber            String?   @map("order_number") // Num√©ro de commande saisi par le testeur
  orderNumberValidatedAt DateTime? @map("order_number_validated_at") // Date de validation par le vendeur

  // Price validation (range check before purchase)
  validatedProductPrice Decimal?  @map("validated_product_price") @db.Decimal(10, 2) // Prix trouv√© et valid√© par le testeur
  priceValidatedAt      DateTime? @map("price_validated_at") // Date de validation du prix

  // Test submission
  submittedAt    DateTime? @map("submitted_at")
  submissionData Json?     @map("submission_data") // Donn√©es du test (photos, vid√©os, r√©ponses)

  // Completion & Payment
  completedAt  DateTime? @map("completed_at")
  productPrice Decimal?  @map("product_price") @db.Decimal(10, 2) // Prix du produit au moment de l'achat
  shippingCost Decimal?  @map("shipping_cost") @db.Decimal(10, 2) // Frais de livraison
  rewardAmount Decimal?  @map("reward_amount") @db.Decimal(10, 2) // Montant de la r√©compense

  // Cancellation
  cancelledAt        DateTime? @map("cancelled_at")
  cancellationReason String?   @map("cancellation_reason") @db.Text

  // Dispute
  disputedAt        DateTime? @map("disputed_at")
  disputeReason     String?   @map("dispute_reason") @db.Text
  disputeResolvedAt DateTime? @map("dispute_resolved_at")
  disputeResolution String?   @map("dispute_resolution") @db.Text
  disputeDeclaredBy String?   @map("dispute_declared_by") // ID du d√©clarant (PRO ou USER)
  isConversationLocked Boolean @default(false) @map("is_conversation_locked") // Bloque messages (sauf admin)

  // Admin participation
  adminJoinedAt  DateTime? @map("admin_joined_at") // Quand admin rejoint
  adminInvitedBy String?   @map("admin_invited_by") // Qui a invit√© l'admin
  adminInvitedAt DateTime? @map("admin_invited_at") // Quand invitation

  // Rating (filled by seller after completion)
  rating        Int? // 1-5 stars
  ratingComment String?   @map("rating_comment") @db.Text
  ratedAt       DateTime? @map("rated_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  messages     Message[] // Messages de cette session
  chatOrders   ChatOrder[] // Commandes de prestations dans le chat
  stepProgress SessionStepProgress[] // Progression dans les steps de la proc√©dure
  review       CampaignReview? // Avis de cette session
  bonusTasks   BonusTask[] // Prestations suppl√©mentaires demand√©es par le vendeur
  transactions Transaction[] // Transactions financi√®res li√©es √† cette session

  @@index([campaignId])
  @@index([testerId])
  @@index([status])
  @@index([appliedAt])
  @@index([createdAt])
  @@index([isConversationLocked])
  @@map("sessions")
}

// Message table - Messagerie entre testeur et vendeur dans une session
model Message {
  id String @id @default(uuid())

  // Relation with session
  sessionId String  @map("session_id")
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Sender (can be tester or seller)
  senderId String  @map("sender_id")
  sender   Profile @relation(fields: [senderId], references: [id], onDelete: Cascade)

  // Message content
  content     String @db.Text
  attachments Json? // Structure: [{ url, filename, size, type, uploadedAt }]

  // Read status
  isRead Boolean   @default(false) @map("is_read")
  readAt DateTime? @map("read_at")
  readBy String?   @map("read_by") // ID de qui a lu (pour "vu par Jean √† 14:32")

  // Message type
  messageType     String?  @default("TEXT") @map("message_type") // TEXT, IMAGE, VIDEO, PDF, SYSTEM
  isSystemMessage Boolean  @default(false) @map("is_system_message") // Messages auto (admin joined, dispute, etc.)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([sessionId])
  @@index([senderId])
  @@index([isRead])
  @@index([createdAt])
  @@index([messageType])
  @@index([isSystemMessage])
  @@map("messages")
}

// Notification table - Notifications envoy√©es aux utilisateurs
model Notification {
  id String @id @default(uuid())

  // Relation with user
  userId String  @map("user_id")
  user   Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification info
  type    NotificationType
  channel NotificationChannel
  title   String
  message String              @db.Text
  data    Json? // Donn√©es additionnelles (IDs, liens, etc.)

  // Status
  isSent Boolean   @default(false) @map("is_sent")
  sentAt DateTime? @map("sent_at")
  isRead Boolean   @default(false) @map("is_read")
  readAt DateTime? @map("read_at")

  // Error tracking
  error   String? @db.Text // Message d'erreur si √©chec d'envoi
  retries Int     @default(0) // Nombre de tentatives

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([type])
  @@index([channel])
  @@index([isSent])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// NotificationPreference table - Pr√©f√©rences de notification par utilisateur
model NotificationPreference {
  id String @id @default(uuid())

  // Relation with user (one-to-one)
  userId String  @unique @map("user_id")
  user   Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Channel preferences
  emailEnabled Boolean @default(true) @map("email_enabled")
  smsEnabled   Boolean @default(false) @map("sms_enabled")
  pushEnabled  Boolean @default(true) @map("push_enabled")
  inAppEnabled Boolean @default(true) @map("in_app_enabled")

  // Notification type preferences
  sessionNotifications  Boolean @default(true) @map("session_notifications")
  messageNotifications  Boolean @default(true) @map("message_notifications")
  paymentNotifications  Boolean @default(true) @map("payment_notifications")
  campaignNotifications Boolean @default(true) @map("campaign_notifications")
  systemNotifications   Boolean @default(true) @map("system_notifications")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@map("notification_preferences")
}

// CampaignReview table - Avis des testeurs sur les campagnes/produits
model CampaignReview {
  id String @id @default(uuid())

  // Relations
  campaignId String   @map("campaign_id")
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  testerId String  @map("tester_id")
  tester   Profile @relation("TesterReviews", fields: [testerId], references: [id], onDelete: Cascade)

  sessionId String  @unique @map("session_id")
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Review content
  rating  Int // 1-5 stars
  comment String? @db.Text

  // Visibility
  isPublic Boolean @default(true) @map("is_public")

  // Republication proposal (pour site vendeur)
  republishProposed Boolean  @default(false) @map("republish_proposed")
  republishAccepted Boolean? @map("republish_accepted")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([campaignId])
  @@index([productId])
  @@index([testerId])
  @@index([sessionId])
  @@index([rating])
  @@index([isPublic])
  @@index([createdAt])
  @@map("campaign_reviews")
}

// BonusTask table - Prestations suppl√©mentaires post-session
// Le vendeur peut demander des prestations additionnelles m√™me apr√®s que la session soit COMPLETED
model BonusTask {
  id String @id @default(uuid())

  // Relation with session
  sessionId String  @map("session_id")
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Task details
  type        BonusTaskType
  title       String
  description String?       @db.Text
  reward      Decimal       @map("reward") @db.Decimal(10, 2) // Montant pay√© pour cette prestation

  // Status
  status BonusTaskStatus @default(REQUESTED)

  // Submission
  submissionUrls String[]  @map("submission_urls") // URLs des fichiers (photos, vid√©os)
  submittedAt    DateTime? @map("submitted_at")

  // Validation
  validatedAt     DateTime? @map("validated_at")
  rejectedAt      DateTime? @map("rejected_at")
  rejectionReason String?   @map("rejection_reason") @db.Text

  // Creator (seller who requested the task)
  requestedBy String  @map("requested_by") // ID du vendeur
  requester   Profile @relation("RequestedBonusTasks", fields: [requestedBy], references: [id], onDelete: Cascade)

  // Relations
  transactions Transaction[] // Transactions li√©es √† cette prestation

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([sessionId])
  @@index([status])
  @@index([requestedBy])
  @@index([createdAt])
  @@map("bonus_tasks")
}

// Enum for transaction types
enum TransactionType {
  CREDIT // Ajout d'argent (r√©compense, bonus)
  DEBIT // Retrait d'argent (retrait bancaire, carte cadeau)
  CAMPAIGN_PAYMENT // Paiement par le vendeur pour une campagne
  CAMPAIGN_REFUND // Remboursement au vendeur (campagne annul√©e)
  CHAT_ORDER_ESCROW // Paiement PRO ‚Üí Escrow (bloqu√© en transit)
  CHAT_ORDER_RELEASE // Escrow ‚Üí Wallet testeur (lib√©r√© apr√®s validation)
  CHAT_ORDER_REFUND // Escrow ‚Üí PRO (rembours√© en cas de litige)
}

// Enum for transaction status
enum TransactionStatus {
  PENDING // En attente de traitement
  COMPLETED // Transaction compl√©t√©e
  FAILED // Transaction √©chou√©e
  REFUNDED // Transaction rembours√©e
  ESCROW // En escrow (fonds bloqu√©s en transit)
}

// Enum for withdrawal methods
enum WithdrawalMethod {
  BANK_TRANSFER // Virement bancaire
  GIFT_CARD // Carte cadeau
}

// Enum for withdrawal status
enum WithdrawalStatus {
  PENDING // En attente de traitement
  PROCESSING // En cours de traitement
  COMPLETED // Retrait compl√©t√©
  FAILED // Retrait √©chou√©
  CANCELLED // Retrait annul√©
}

// Wallet table - Portefeuille financier de l'utilisateur (testeur)
model Wallet {
  id String @id @default(uuid())

  // Relation with user (one-to-one)
  userId String  @unique @map("user_id")
  user   Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Balance
  balance        Decimal @default(0) @db.Decimal(10, 2) // Solde disponible pour retrait
  pendingBalance Decimal @default(0) @map("pending_balance") @db.Decimal(10, 2) // Argent en escrow (bloqu√©)
  currency       String  @default("EUR") // Devise (EUR par d√©faut)

  // Lifetime stats
  totalEarned     Decimal   @default(0) @map("total_earned") @db.Decimal(10, 2) // Total gagn√© depuis la cr√©ation
  totalWithdrawn  Decimal   @default(0) @map("total_withdrawn") @db.Decimal(10, 2) // Total retir√©
  lastCreditedAt  DateTime? @map("last_credited_at") // Date du dernier cr√©dit
  lastWithdrawnAt DateTime? @map("last_withdrawn_at") // Date du dernier retrait

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  transactions Transaction[] // Historique des transactions

  @@index([userId])
  @@index([balance])
  @@map("wallets")
}

// Transaction table - Historique des transactions financi√®res
model Transaction {
  id String @id @default(uuid())

  // Relation with wallet (optional - null for seller payments)
  walletId String? @map("wallet_id")
  wallet   Wallet? @relation(fields: [walletId], references: [id], onDelete: Cascade)

  // Transaction info
  type   TransactionType
  amount Decimal         @db.Decimal(10, 2) // Montant (toujours positif, le type indique CREDIT/DEBIT)
  reason String // Description de la transaction

  // Related entities
  sessionId    String?     @map("session_id") // Lien vers une session si applicable
  session      Session?    @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  bonusTaskId  String?     @map("bonus_task_id") // Lien vers une bonus task si applicable
  bonusTask    BonusTask?  @relation(fields: [bonusTaskId], references: [id], onDelete: SetNull)
  withdrawalId String?     @map("withdrawal_id") // Lien vers un retrait si applicable
  withdrawal   Withdrawal? @relation(fields: [withdrawalId], references: [id], onDelete: SetNull)
  campaignId   String?     @map("campaign_id") // Lien vers une campagne si applicable (paiement vendeur)
  campaign     Campaign?   @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  chatOrderId  String?     @map("chat_order_id") // Lien vers une commande chat si applicable
  chatOrder    ChatOrder?  @relation(fields: [chatOrderId], references: [id], onDelete: SetNull)

  // Relations inverses pour escrow (une transaction peut √™tre escrow OU release pour une commande)
  escrowForOrder  ChatOrder? @relation("EscrowTransaction")
  releaseForOrder ChatOrder? @relation("ReleaseTransaction")

  // Stripe payment reference
  stripePaymentIntentId String? @unique @map("stripe_payment_intent_id") // ID du PaymentIntent Stripe
  stripeSessionId       String? @unique @map("stripe_session_id") // ID de la Checkout Session Stripe

  // Status & metadata
  status        TransactionStatus @default(COMPLETED)
  failureReason String?           @map("failure_reason") @db.Text // Raison de l'√©chec si FAILED
  metadata      Json? // Donn√©es additionnelles (r√©f√©rences, d√©tails)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([walletId])
  @@index([sessionId])
  @@index([bonusTaskId])
  @@index([withdrawalId])
  @@index([campaignId])
  @@index([chatOrderId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("transactions")
}

// Withdrawal table - Demandes de retrait d'argent
model Withdrawal {
  id String @id @default(uuid())

  // Relation with user (testeur)
  userId String  @map("user_id")
  user   Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Withdrawal info
  amount   Decimal          @db.Decimal(10, 2) // Montant du retrait
  method   WithdrawalMethod // M√©thode de retrait
  status   WithdrawalStatus @default(PENDING)
  currency String           @default("EUR")

  // Payment details (varie selon la m√©thode)
  paymentDetails Json? @map("payment_details") // IBAN pour virement, type de carte cadeau, etc.

  // Processing info
  processedAt        DateTime? @map("processed_at") // Date de traitement
  completedAt        DateTime? @map("completed_at") // Date de compl√©tion
  failedAt           DateTime? @map("failed_at") // Date d'√©chec
  failureReason      String?   @map("failure_reason") @db.Text // Raison de l'√©chec
  cancelledAt        DateTime? @map("cancelled_at") // Date d'annulation
  cancellationReason String?   @map("cancellation_reason") @db.Text // Raison de l'annulation

  // Admin info
  processedBy String? @map("processed_by") // ID de l'admin qui a trait√©
  notes       String? @db.Text // Notes internes admin

  // Metadata
  metadata Json? // Donn√©es additionnelles (r√©f√©rence de paiement, etc.)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  transactions Transaction[] // Transactions li√©es √† ce retrait

  @@index([userId])
  @@index([status])
  @@index([method])
  @@index([createdAt])
  @@map("withdrawals")
}

// ChatOrder table - Commandes de prestations suppl√©mentaires dans le chat
model ChatOrder {
  id String @id @default(uuid())

  // Relation with session
  sessionId String  @map("session_id")
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Participants
  buyerId  String  @map("buyer_id") // PRO qui commande
  buyer    Profile @relation("ChatOrderBuyer", fields: [buyerId], references: [id], onDelete: Restrict)
  sellerId String  @map("seller_id") // Testeur qui livre
  seller   Profile @relation("ChatOrderSeller", fields: [sellerId], references: [id], onDelete: Restrict)

  // Order details
  type        ChatOrderType
  status      ChatOrderStatus @default(PENDING)
  amount      Decimal         @db.Decimal(10, 2) // Montant de la prestation
  description String          @db.Text // Description de la demande

  // Delivery
  deliveryDeadline DateTime? @map("delivery_deadline") // Date limite de livraison
  deliveryProof    Json?     @map("delivery_proof") // Fichiers livr√©s (structure: [{ url, filename, size, type }])
  deliveredAt      DateTime? @map("delivered_at")

  // Validation
  validatedAt DateTime? @map("validated_at") // Quand le PRO a valid√©
  validatedBy String?   @map("validated_by") // ID du PRO qui a valid√©

  // Rejection
  rejectedAt      DateTime? @map("rejected_at")
  rejectionReason String?   @map("rejection_reason") @db.Text

  // Cancellation
  cancelledAt DateTime? @map("cancelled_at")

  // Dispute
  disputedAt        DateTime? @map("disputed_at")
  disputeReason     String?   @map("dispute_reason") @db.Text
  disputeResolvedAt DateTime? @map("dispute_resolved_at")
  disputeResolution String?   @map("dispute_resolution") @db.Text
  disputeResolvedBy String?   @map("dispute_resolved_by") // Admin ID

  // Payment tracking (escrow transactions)
  escrowTransactionId  String?      @unique @map("escrow_transaction_id") // Transaction escrow (ESCROW)
  escrowTransaction    Transaction? @relation("EscrowTransaction", fields: [escrowTransactionId], references: [id])
  releaseTransactionId String?      @unique @map("release_transaction_id") // Transaction lib√©ration (COMPLETED)
  releaseTransaction   Transaction? @relation("ReleaseTransaction", fields: [releaseTransactionId], references: [id])

  // Relation inverse pour transactions normales (non-escrow, non-release)
  transactions Transaction[] // Transactions li√©es √† cette commande (via chatOrderId)

  // Metadata
  metadata Json? // Donn√©es additionnelles

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([sessionId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("chat_orders")
}
